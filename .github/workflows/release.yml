name: Release

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  release:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
      
      - name: Install dependencies
        run: npm install --production
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Get the latest tag or use v1.0.0 as default
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            # Increment patch version
            VERSION=$(echo $LATEST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Version: $(cat $GITHUB_OUTPUT | grep VERSION)"
      
      - name: Create release archives
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Create directories for each platform
          mkdir -p releases/windows releases/linux releases/mac
          
          # Copy common files (copy each individually to handle missing files)
          for dir in windows linux mac; do
            cp bot.js releases/$dir/
            cp package.json releases/$dir/
            cp config.template.json releases/$dir/
            cp .env.example releases/$dir/
            cp README.md releases/$dir/
            cp LICENSE releases/$dir/
            cp -r node_modules releases/$dir/
            [ -f package-lock.json ] && cp package-lock.json releases/$dir/ || true
          done
          
          # Windows release
          echo "@echo off" > releases/windows/start.bat
          echo "node bot.js" >> releases/windows/start.bat
          cd releases/windows && zip -r ../donutsmp-mapflipper-${VERSION}-windows.zip . && cd ../..
          
          # Linux release
          cp start.sh releases/linux/
          chmod +x releases/linux/start.sh
          cd releases/linux && tar -czf ../donutsmp-mapflipper-${VERSION}-linux.tar.gz . && cd ../..
          
          # Mac release
          cp start.sh releases/mac/
          chmod +x releases/mac/start.sh
          cd releases/mac && tar -czf ../donutsmp-mapflipper-${VERSION}-mac.tar.gz . && cd ../..
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## DonutSMP Map Flipper Bot ${{ steps.version.outputs.VERSION }}
            
            Automatic release created from merged pull request.
            
            ### Downloads
            - **Windows**: `donutsmp-mapflipper-${{ steps.version.outputs.VERSION }}-windows.zip`
            - **Linux**: `donutsmp-mapflipper-${{ steps.version.outputs.VERSION }}-linux.tar.gz`
            - **Mac**: `donutsmp-mapflipper-${{ steps.version.outputs.VERSION }}-mac.tar.gz`
            
            ### Installation
            1. Download the appropriate file for your operating system
            2. Extract the archive
            3. Copy `config.template.json` to `config.json` and configure your settings
            4. Run the bot:
               - **Windows**: Double-click `start.bat` or run `node bot.js`
               - **Linux/Mac**: Run `./start.sh` or `node bot.js`
            
            See the [README.md](https://github.com/TreXito/donutsmp-mapflipper/blob/main/README.md) for detailed setup instructions.
          draft: false
          prerelease: false
          files: |
            releases/donutsmp-mapflipper-${{ steps.version.outputs.VERSION }}-windows.zip
            releases/donutsmp-mapflipper-${{ steps.version.outputs.VERSION }}-linux.tar.gz
            releases/donutsmp-mapflipper-${{ steps.version.outputs.VERSION }}-mac.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
